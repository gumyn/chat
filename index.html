<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GunChat Decentralized</title>

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Gun.js & SEA -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/radix.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/store.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/rindexed.js"></script>

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.2);
            --accent-color: #00d2ff;
            --accent-secondary: #928DAB;
            --text-main: #ffffff;
            --text-muted: #b3b3b3;
            --danger: #ff4b4b;
            --success: #00ff88;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- Utilities --- */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Auth Screen --- */
        #auth-container {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        #auth-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 210, 255, 0.1) 0%, transparent 60%);
            animation: rotate 10s linear infinite;
            z-index: -1;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        h1 {
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 2rem;
        }

        p.subtitle {
            color: var(--text-muted);
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }

        .input-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .input-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-color);
        }

        input {
            width: 100%;
            padding: 12px 12px 12px 45px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(0, 210, 255, 0.2);
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 1rem;
        }

        .btn-primary {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 210, 255, 0.4);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
        }

        .btn-secondary:hover {
            background: var(--glass-border);
            color: white;
        }

        /* --- App Layout --- */
        #app-container {
            width: 95vw;
            height: 90vh;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            display: flex;
            overflow: hidden;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Sidebar */
        #sidebar {
            width: 300px;
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .users-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 5px;
        }

        .user-item:hover,
        .user-item.active {
            background: rgba(255, 255, 255, 0.1);
        }

        .user-item .avatar {
            width: 32px;
            height: 32px;
            font-size: 0.9rem;
            margin-right: 10px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .user-status {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Chat Area */
        #chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.02);
            position: relative;
        }

        .chat-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.1);
        }

        .chat-title h2 {
            font-size: 1.2rem;
        }

        .chat-title span {
            font-size: 0.8rem;
            color: var(--accent-color);
        }

        #messages-container {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: slideIn 0.3s ease;
            word-wrap: break-word;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.own {
            align-self: flex-end;
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.other {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            border-bottom-left-radius: 4px;
        }

        .message-meta {
            font-size: 0.7rem;
            margin-bottom: 4px;
            opacity: 0.8;
            display: block;
        }

        .message-time {
            font-size: 0.65rem;
            opacity: 0.6;
            margin-top: 4px;
            display: block;
            text-align: right;
        }

        .chat-input-area {
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.1);
            border-top: 1px solid var(--glass-border);
            display: flex;
            gap: 10px;
        }

        .chat-input-area input {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            border: none;
            background: var(--accent-color);
            color: #0f0c29;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Loader */
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--accent-color);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 5px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-msg {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: 10px;
            min-height: 20px;
        }

        /* Responsive Mobile Fixes */
        @media (max-width: 768px) {
            body {
                overflow: hidden;
                /* Prevent body scroll */
            }

            #app-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                border: none;
                border-radius: 0;
                margin: 0;
                flex-direction: column;
                background: #1a1a2e;
                /* Solid background for mobile */
            }

            /* Sidebar View */
            #sidebar {
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                border-right: none;
                z-index: 1;
            }

            /* Chat View */
            #chat-area {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #1a1a2e;
                z-index: 10;
                display: none;
                /* Hidden by default */
                flex-direction: column;
            }

            /* Toggle Logic */
            #app-container.show-chat #chat-area {
                display: flex;
            }

            #app-container.show-chat #sidebar {
                display: none;
            }

            /* Header Adjustments */
            .sidebar-header,
            .chat-header {
                padding: 1rem;
                height: 70px;
                flex-shrink: 0;
            }

            /* Message Area */
            #messages-container {
                flex: 1;
                padding: 1rem;
                padding-bottom: 80px;
                /* Space for input */
            }

            /* Input Area */
            .chat-input-area {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                padding: 10px;
                padding-bottom: max(10px, env(safe-area-inset-bottom));
                background: rgba(26, 26, 46, 0.95);
                backdrop-filter: blur(10px);
                border-top: 1px solid var(--glass-border);
                z-index: 20;
            }

            .back-btn {
                display: block !important;
                margin-right: 15px;
                font-size: 1.4rem;
                padding: 5px;
            }

            /* Ensure user items look like desktop */
            .users-list {
                display: block;
                /* Reset flex if it was set differently */
                padding: 1rem;
            }

            .user-item {
                flex-direction: row;
                /* Force row */
                justify-content: flex-start;
                margin-bottom: 5px;
                width: 100%;
            }

            .user-info {
                display: flex !important;
                /* Force show */
                flex-direction: column;
            }

            .user-item .avatar {
                margin-right: 10px;
                margin-bottom: 0;
                width: 40px;
                height: 40px;
            }
        }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background: var(--bg-gradient);
            width: 90%;
            max-width: 500px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            transform: translateY(20px);
            transition: transform 0.3s ease;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-overlay.open .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close {
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-muted);
        }

        .modal-close:hover {
            color: white;
        }

        .modal-body {
            overflow-y: auto;
            flex: 1;
        }

        .affiliate-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .affiliate-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .affiliate-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .affiliate-input {
            width: 60px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            text-align: center;
        }

        .affiliate-link-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            word-break: break-all;
            font-family: monospace;
            border: 1px solid var(--glass-border);
            cursor: pointer;
        }

        .affiliate-link-box:hover {
            border-color: var(--accent-color);
        }

        .copy-hint {
            font-size: 0.7rem;
            color: var(--accent-color);
            margin-top: 5px;
            text-align: right;
        }
    </style>
</head>

<body>

    <!-- Auth Section -->
    <div id="auth-container" class="fade-in">
        <h1>GunChat <span class="version">v1.3</span> <i class="fa-solid fa-bolt"
                style="color: var(--accent-color);"></i></h1>
        <p class="subtitle">Décentralisé, Sécurisé, Temps Réel</p>

        <div class="input-group">
            <i class="fa-solid fa-user"></i>
            <input type="text" id="username" placeholder="Nom d'utilisateur" autocomplete="off"
                onkeypress="handleAuthEnter(event)">
        </div>
        <div class="input-group">
            <i class="fa-solid fa-lock"></i>
            <input type="password" id="password" placeholder="Mot de passe" onkeypress="handleAuthEnter(event)">
        </div>

        <button class="btn btn-primary" onclick="login()">Se Connecter</button>
        <button class="btn btn-secondary" onclick="signup()">Créer un compte</button>

        <div id="auth-error" class="error-msg"></div>
    </div>

    <!-- App Section -->
    <div id="app-container" class="hidden fade-in">
        <!-- Sidebar -->
        <div id="sidebar">
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="avatar" id="my-avatar">?</div>
                    <div>
                        <div class="user-name" id="my-username">Guest</div>
                        <div class="user-status">En ligne</div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <i class="fa-solid fa-hand-holding-dollar" style="cursor: pointer; color: var(--accent-color);"
                        onclick="openAffiliateModal()" title="Affiliation"></i>
                    <i class="fa-solid fa-right-from-bracket" style="cursor: pointer; color: var(--text-muted);"
                        onclick="logout()" title="Déconnexion"></i>
                </div>
            </div>

            <div class="users-list" id="users-list">
                <div class="user-item active" onclick="switchChat('global')">
                    <div class="avatar" style="background: linear-gradient(135deg, #ff9966, #ff5e62);"><i
                            class="fa-solid fa-globe"></i></div>
                    <div class="user-info">
                        <div class="user-name">Salon Global</div>
                        <div class="user-status">Tout le monde</div>
                    </div>
                </div>
                <!-- Users will be injected here -->
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-area">
            <div class="chat-header">
                <div style="display: flex; align-items: center;">
                    <i class="fa-solid fa-arrow-left back-btn" onclick="showSidebar()" style="margin-right: 10px;"></i>
                    <div class="chat-title">
                        <h2 id="current-chat-name">Salon Global</h2>
                        <span id="current-chat-status">Chat public</span>
                    </div>
                </div>
                <div class="chat-actions">
                    <i class="fa-solid fa-video" style="margin-right: 15px; opacity: 0.5; cursor: not-allowed;"></i>
                    <i class="fa-solid fa-phone" style="opacity: 0.5; cursor: not-allowed;"></i>
                </div>
            </div>

            <div id="messages-container">
                <!-- Messages will be injected here -->
                <div style="text-align: center; color: var(--text-muted); margin-top: 20px; font-size: 0.8rem;">
                    Bienvenue dans le chat ! Les messages sont stockés via Gun.js.
                </div>
            </div>

            <div class="chat-input-area">
                <input type="text" id="message-input" placeholder="Écrivez votre message..."
                    onkeypress="handleEnter(event)">
                <button class="send-btn" onclick="sendMessage()">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
    </div>

    <!-- Affiliate Modal -->
    <div id="affiliate-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Affiliation <i class="fa-solid fa-coins" style="color: var(--success);"></i>
                </div>
                <i class="fa-solid fa-xmark modal-close" onclick="closeAffiliateModal()"></i>
            </div>
            <div class="modal-body">
                <!-- Tabs or Sections -->
                <div style="margin-bottom: 20px;">
                    <h3>Mon Lien Affilié</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px;">Partagez ce lien pour
                        recevoir vos commissions.</p>
                    <div class="affiliate-link-box" onclick="copyLink(this)" id="my-affiliate-link">
                        Chargement...
                    </div>
                    <div class="copy-hint">Cliquer pour copier</div>
                    <div style="margin-top: 10px; font-size: 0.9rem;">
                        Votre commission actuelle : <span id="my-commission-rate"
                            style="color: var(--success); font-weight: bold;">0%</span>
                    </div>
                </div>

                <hr style="border: 0; border-top: 1px solid var(--glass-border); margin: 20px 0;">

                <div id="admin-section">
                    <h3>Gestion des Vendeurs</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px;">Définir les commissions
                        (Admin)</p>
                    <div id="affiliates-list">
                        <!-- List injected via JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Initialization ---
        // Using multiple peers for better reliability
        const peers = [
            // Local peer (if running node server.js)
            location.origin + '/gun',
            // Community peers (public, may be unstable)
            'http://0.0.0.0:8888/gun',
            // 'https://plankton-app-6qfp3.ondigitalocean.app/gun',
            // 'https://gun-chat-dapp.web.app/gun',
            // 'https://gun-manhattan.herokuapp.com/gun',
            // 'https://gun-us.herokuapp.com/gun',
            // 'https://gun-eu.herokuapp.com/gun',
            // 'https://phrassed.com/gun',
            // 'https://mvp-gun.herokuapp.com/gun'
        ];
        const gun = Gun({ peers: peers, localStorage: true });
        const user = gun.user();
        const SEA = Gun.SEA;

        // State
        let currentUser = { alias: '', pub: '' };
        let currentChat = { type: 'global', pub: null, alias: 'Salon Global', sharedSecret: null };
        let usersMap = new Map(); // pub -> alias

        // --- Auth Functions ---
        function signup() {
            const alias = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            if (!alias || !pass) return showError('Veuillez remplir tous les champs');

            showError('<div class="loader"></div> Création...', true);
            user.create(alias, pass, (ack) => {
                if (ack.err) {
                    showError(ack.err);
                } else {
                    login(); // Auto login after signup
                }
            });
        }

        function login() {
            const alias = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            if (!alias || !pass) return showError('Veuillez remplir tous les champs');

            showError('<div class="loader"></div> Connexion...', true);
            user.auth(alias, pass, (ack) => {
                if (ack.err) {
                    showError(ack.err);
                } else {
                    // Success
                    document.getElementById('auth-error').innerHTML = '';
                    onAuthSuccess(alias, ack.sea.pub);
                }
            });
        }

        function logout() {
            user.leave();
            location.reload();
        }

        function showError(msg, isHtml = false) {
            const el = document.getElementById('auth-error');
            if (isHtml) el.innerHTML = msg;
            else el.textContent = msg;
        }

        function onAuthSuccess(alias, pub) {
            currentUser = { alias, pub };

            // UI Updates
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('my-username').textContent = alias;
            document.getElementById('my-avatar').textContent = alias.substring(0, 2).toUpperCase();

            // Announce presence
            // We write to a public 'users' node. 
            // In a real app, we'd want to avoid a global list for scalability, but for this demo it's fine.
            gun.get('gun-chat-demo-users').get(pub).put({
                alias: alias,
                pub: pub,
                lastSeen: Date.now()
            });

            // Load Users
            loadUsers();

            // Load Global Chat by default
            switchChat('global');
        }

        // --- User Management ---
        function loadUsers() {
            gun.get('gun-chat-demo-users').map().on((data, pub) => {
                if (!data || !data.alias || pub === currentUser.pub) return;

                usersMap.set(pub, data.alias);
                renderUserInSidebar(pub, data.alias);
            });
        }

        function renderUserInSidebar(pub, alias) {
            const list = document.getElementById('users-list');
            let el = document.getElementById(`user-${pub}`);

            if (!el) {
                el = document.createElement('div');
                el.id = `user-${pub}`;
                el.className = 'user-item';
                el.onclick = () => switchChat('private', pub, alias);

                el.innerHTML = `
                    <div class="avatar">${alias.substring(0, 2).toUpperCase()}</div>
                    <div class="user-info">
                        <div class="user-name">${alias}</div>
                        <div class="user-status">Utilisateur</div>
                    </div>
                `;
                list.appendChild(el);
            }
        }

        // --- Chat Logic ---
        async function switchChat(type, pub = null, alias = null) {
            // Mobile: Show chat view
            document.getElementById('app-container').classList.add('show-chat');

            // Update State
            currentChat = { type, pub, alias };

            // Update UI Header
            document.getElementById('current-chat-name').textContent = alias || 'Salon Global';
            document.getElementById('current-chat-status').textContent = type === 'global' ? 'Chat public' : 'Message Privé (Chiffré)';

            // Update Active Class in Sidebar
            document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
            if (type === 'global') {
                document.querySelector('.users-list .user-item:first-child').classList.add('active');
            } else {
                const userEl = document.getElementById(`user-${pub}`);
                if (userEl) userEl.classList.add('active');
            }

            // Clear messages area
            const container = document.getElementById('messages-container');
            container.innerHTML = '';

            // Compute Secret if Private
            if (type === 'private') {
                // We need the other user's epub (encryption public key)
                // Standard Gun user structure puts epub at user.epub
                // But we only have their pub (signing key) from the list.
                // We need to fetch their epub.
                // For this demo, we will assume the standard path: gun.user(pub).once(...)

                // Note: Getting another user's epub can be tricky if they haven't published it publicly in a known spot.
                // Gun.user(pub) usually has 'epub' property.

                gun.user(pub).once(async (data) => {
                    if (data && data.epub) {
                        currentChat.epub = data.epub;
                        currentChat.sharedSecret = await SEA.secret(data.epub, user._.sea);
                        subscribeToMessages();
                    } else {
                        // Fallback or wait
                        // If we can't find epub, we can't encrypt.
                        console.log("Could not find epub for user");
                    }
                });
            } else {
                subscribeToMessages();
            }
        }

        function showSidebar() {
            document.getElementById('app-container').classList.remove('show-chat');
        }

        let messageListener = null; // To keep track and turn off if needed (Gun .off() is tricky, usually we just ignore old events in UI or clear container)

        function subscribeToMessages() {
            const container = document.getElementById('messages-container');
            container.innerHTML = ''; // Clear again to be safe

            if (currentChat.type === 'global') {
                // Global Chat: Read from 'gun-chat-demo-global'
                // We limit to last 50 to avoid loading history forever in this demo
                gun.get('gun-chat-demo-global').map().once((data, id) => {
                    if (!data) return;
                    renderMessage(data, id);
                });
            } else {
                // Private Chat
                // We will use a shared node derived from both pub keys sorted.
                // Node: 'gun-chat-demo-dms' -> sorted_pubs_string
                const pubs = [currentUser.pub, currentChat.pub].sort().join('~');

                gun.get('gun-chat-demo-dms').get(pubs).map().once(async (data, id) => {
                    if (!data) return;
                    // Decrypt
                    if (typeof data.msg === 'string' && data.msg.startsWith('SEA{')) {
                        try {
                            const decrypted = await SEA.decrypt(data.msg, currentChat.sharedSecret);
                            if (decrypted) {
                                renderMessage({ ...data, msg: decrypted }, id);
                            }
                        } catch (e) { console.error(e); }
                    }
                });
            }
        }

        function renderMessage(data, id) {
            // Check if already rendered
            if (document.getElementById(`msg-${id}`)) return;

            const container = document.getElementById('messages-container');
            const isOwn = data.pub === currentUser.pub;

            const div = document.createElement('div');
            div.id = `msg-${id}`;
            div.className = `message ${isOwn ? 'own' : 'other'}`;

            const time = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            div.innerHTML = `
                <span class="message-meta">${isOwn ? 'Moi' : (data.alias || 'Inconnu')}</span>
                ${escapeHtml(data.msg)}
                <span class="message-time">${time}</span>
            `;

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;

            const msgData = {
                msg: text,
                alias: currentUser.alias,
                pub: currentUser.pub,
                timestamp: Date.now()
            };

            if (currentChat.type === 'global') {
                gun.get('gun-chat-demo-global').set(msgData);
            } else {
                if (!currentChat.sharedSecret) {
                    alert("Encryption key not ready yet. Wait a moment.");
                    return;
                }
                const encrypted = await SEA.encrypt(text, currentChat.sharedSecret);
                const pubs = [currentUser.pub, currentChat.pub].sort().join('~');

                gun.get('gun-chat-demo-dms').get(pubs).set({
                    ...msgData,
                    msg: encrypted
                });
            }

            input.value = '';
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function handleAuthEnter(e) {
            if (e.key === 'Enter') login();
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- Affiliate System ---
        function openAffiliateModal() {
            document.getElementById('affiliate-modal').classList.add('open');
            loadAffiliateData();
        }

        function closeAffiliateModal() {
            document.getElementById('affiliate-modal').classList.remove('open');
        }

        function loadAffiliateData() {
            // 1. Generate My Link (Dynamic via Server)
            // Instead of a static link, we give them a link to our "buy" page with their ref
            // Or we can generate a specific checkout link on demand.

            // For this demo, let's show a "Smart Link" that users can share.
            // When someone clicks this link, your site would normally call the API.
            const mySmartLink = `${location.origin}/buy?ref=${currentUser.pub}`;
            document.getElementById('my-affiliate-link').textContent = mySmartLink;

            // 2. Load My Rate
            gun.get('affiliate_rates').get(currentUser.pub).on((rate) => {
                document.getElementById('my-commission-rate').textContent = (rate || 0) + '%';
            });

            // 3. Load All Users for Admin
            const list = document.getElementById('affiliates-list');
            list.innerHTML = '';

            usersMap.forEach((alias, pub) => {
                const div = document.createElement('div');
                div.className = 'affiliate-item';
                div.innerHTML = `
                    <div class="affiliate-user">
                        <div class="avatar" style="width: 30px; height: 30px; font-size: 0.8rem;">${alias.substring(0, 2).toUpperCase()}</div>
                        <div style="font-size: 0.9rem;">${alias}</div>
                    </div>
                    <div class="affiliate-input-group">
                        <input type="number" class="affiliate-input" min="0" max="100" id="rate-${pub}" onchange="updateRate('${pub}', this.value)">
                        <span>%</span>
                    </div>
                `;
                list.appendChild(div);

                // Load existing rate
                gun.get('affiliate_rates').get(pub).once((rate) => {
                    if (rate) document.getElementById(`rate-${pub}`).value = rate;
                });
            });
        }

        // Function to simulate buying (what happens when a customer clicks the smart link)
        async function simulatePurchase(affiliatePub) {
            try {
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        affiliatePub: affiliatePub,
                        productId: 'premium_sub'
                    })
                });
                const data = await response.json();
                console.log("Stripe Session URL:", data.url);
                alert(`Redirection vers Stripe...\n(Simulation: ${data.url})`);
                // window.location.href = data.url; // Real redirect
            } catch (e) {
                console.error(e);
                alert("Erreur lors de la création du paiement");
            }
        }

        function updateRate(pub, rate) {
            gun.get('affiliate_rates').get(pub).put(rate);
        }

        function copyLink(el) {
            const text = el.textContent.trim();
            navigator.clipboard.writeText(text).then(() => {
                const original = el.style.borderColor;
                el.style.borderColor = 'var(--success)';
                setTimeout(() => el.style.borderColor = original, 500);
            });
        }

        // Check if already logged in (Gun persists session)
        gun.on('auth', (ack) => {
            // If we are here, it means session was restored or login happened
            // We can get the alias from the user object if available
            if (user.is) {
                onAuthSuccess(user.is.alias, user.is.pub);
            }
        });

    </script>
</body>

</html>